<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AWSTUFF</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Raimon Grau" />
<meta name="keywords" content="bash zsh shell" />
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<link rel="stylesheet" type="text/css" href="styles.css"/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">AWSTUFF</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org24106d4">1. AWS Lambda</a>
<ul>
<li><a href="#org5e3b3aa">1.1. One off simple python Lambda</a>
<ul>
<li><a href="#org618e501">1.1.1. Hello world</a></li>
<li><a href="#orge2fdb43">1.1.2. Monitor</a></li>
<li><a href="#orgdc74996">1.1.3. Schdedule</a></li>
</ul>
</li>
<li><a href="#org795f5d7">1.2. One off not-so-simple python Lambda</a>
<ul>
<li><a href="#org17a7736">1.2.1. Layer vs bundling</a></li>
<li><a href="#org31057b0">1.2.2. Env vars</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgc74e5cc">2. Terraform</a></li>
<li><a href="#org240d377">3. AIM</a></li>
<li><a href="#org272f982">4. aws-mfa</a></li>
<li><a href="#orge444f33">5. awslogs get '/bla/my-log-group' ALL  &#x2013;start=1h &#x2013;watch | grep '/bla/my-log-group/something' | lnav</a></li>
</ul>
</div>
</div>

<div id="outline-container-org24106d4" class="outline-2">
<h2 id="org24106d4"><span class="section-number-2">1</span> AWS Lambda</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org5e3b3aa" class="outline-3">
<h3 id="org5e3b3aa"><span class="section-number-3">1.1</span> One off simple python Lambda</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Like a way to have cheap scripts that run daily, to fetch stuff
from the internet and synchronize data, or smth.
</p>

<p>
Lambdas are region based, so open the region you want to run in.
</p>
</div>
<div id="outline-container-org618e501" class="outline-4">
<h4 id="org618e501"><span class="section-number-4">1.1.1</span> Hello world</h4>
<div class="outline-text-4" id="text-1-1-1">
<ul class="org-ul">
<li>Open the lambda AWS cli</li>
<li>Create Function</li>
<li>blueprint: hello-world-python</li>
<li>name: my-f</li>
<li>next, next, next, TEST.</li>
<li>yay</li>
</ul>

<p>
Things to take into account are that the lamdba is called via the function
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">lambda_handler</span>(event, context):
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"hello!"</span>)
</pre>
</div>

<p>
The file is called <code>lambda_function.py</code> IIRC
</p>
</div>
</div>
<div id="outline-container-orge2fdb43" class="outline-4">
<h4 id="orge2fdb43"><span class="section-number-4">1.1.2</span> Monitor</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
There are (at least) 2 ways of monitoring single executions of lambdas:
</p>
</div>
<ol class="org-ol">
<li><a id="orge962fa5"></a>Via cloudwatch<br />
<div class="outline-text-5" id="text-1-1-2-1">
<p>
To get notified if it fails via cloudwatch, we'll have to create a
cloudwatch alarm with thresholds of 1, and and sns with an email
destination.
</p>

<ul class="org-ul">
<li>Click on <code>monitor</code> tab.</li>
<li>View logs on cloudwatch</li>
<li>click on the alarms on the sidebar (not really where the link
brought us)</li>
<li>Create Alarm</li>
<li>Select metric: Lambdas-&gt;by function-&gt;my-f:Errors</li>
<li>statistic: sum, period: 1m, &gt;=1</li>
<li>In Alarm, select (or create) SNS topic.</li>
</ul>
</div>
</li>
<li><a id="org386a619"></a>Via Lambda destination<br />
<div class="outline-text-5" id="text-1-1-2-2">
<ul class="org-ul">
<li>Add Destination</li>
<li>on error</li>
<li>sns topic</li>
</ul>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgdc74996" class="outline-4">
<h4 id="orgdc74996"><span class="section-number-4">1.1.3</span> Schdedule</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
We add scheduling "triggers" from the perspective
</p>
</div>
</div>
</div>
<div id="outline-container-org795f5d7" class="outline-3">
<h3 id="org795f5d7"><span class="section-number-3">1.2</span> One off not-so-simple python Lambda</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Let's try to use an external lib, like stripe. For stripe you need
2 things, the lib, and the token.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> stripe
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">lambda_handler</span>(event, context):
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"hello!"</span>)
</pre>
</div>
</div>
<div id="outline-container-org17a7736" class="outline-4">
<h4 id="org17a7736"><span class="section-number-4">1.2.1</span> Layer vs bundling</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
There are 2 ways to use external libs: Bundling and using layers:
</p>
</div>
<ol class="org-ol">
<li><a id="orgeffb135"></a>Bundle<br />
<div class="outline-text-5" id="text-1-2-1-1">
<p>
As they explain <a href="https://stackoverflow.com/questions/36411364/how-to-use-stripe-apis-on-aws-lambda-in-python">here</a>, you can bundle all needed libs in the same
zip together with your function.  <code>pip install --target\</code>"$PWD"
&#x2013;upgrade stripe; zip -r my-fun.zip *=.
</p>
</div>
</li>
<li><a id="org33f9ad7"></a>Layers<br />
<div class="outline-text-5" id="text-1-2-1-2">
<p>
A more sophisticated way is to upload the lib separately, and
then combine your function and the layer.  As explained <a href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html">in the
official docs</a>, your libs have to be in a concrete path so that
the "main" lambda function gets them. Another example <a href="https://wakeupcoders.medium.com/how-to-use-external-libraries-in-lambda-function-df1cee4a7c3a">here</a>.
</p>

<p>
Note: Check if the paths from "Layers" are also accepted in
"Bundle". Maybe there's no need to put the whole thing in the
same directory and we can use the same strategy. That'd make
sense.
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="font-weight: bold;">echo</span> <span style="font-style: italic;">'stripe'</span> &gt; requirements.txt
python -m venv venv;
. venv/bin/activate
pip install -r requirements.txt
mkdir build/python/lib/python3.7/site-packages
cp -a venv/lib/python3.7/site-packages build/python/lib/python3.7/site-packages
<span style="font-weight: bold;">cd</span> build; zip -r ../stripe.zip .
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-org31057b0" class="outline-4">
<h4 id="org31057b0"><span class="section-number-4">1.2.2</span> Env vars</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
Our file is now something like this
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> os
<span style="font-weight: bold;">import</span> stripe
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">lambda_handler</span>(event, context):
    <span style="font-weight: bold; font-style: italic;">stripe.api_key</span>=os.environ.get(<span style="font-style: italic;">'STRIPE_SK'</span>, <span style="font-style: italic;">''</span>)
    <span style="font-weight: bold;">for</span> c <span style="font-weight: bold;">in</span> stripe.Customers.<span style="font-weight: bold;">list</span>():
      <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">'hello '</span>, c.name)
</pre>
</div>

<p>
Go to the Configuration tab, "environment variables", and add your env var.
</p>

<p>
Make sure everything is deployed, test and yay!
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc74e5cc" class="outline-2">
<h2 id="orgc74e5cc"><span class="section-number-2">2</span> Terraform</h2>
</div>
<div id="outline-container-org240d377" class="outline-2">
<h2 id="org240d377"><span class="section-number-2">3</span> AIM</h2>
</div>
<div id="outline-container-org272f982" class="outline-2">
<h2 id="org272f982"><span class="section-number-2">4</span> aws-mfa</h2>
</div>
<div id="outline-container-orge444f33" class="outline-2">
<h2 id="orge444f33"><span class="section-number-2">5</span> awslogs get '/bla/my-log-group' ALL  &#x2013;start=1h &#x2013;watch | grep '/bla/my-log-group/something' | lnav</h2>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Raimon Grau</p>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 26.1 (<a href="https://orgmode.org">Org</a> mode 9.1.9)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
